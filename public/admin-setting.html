<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>全局设定</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { margin:0; padding-top:56px; font-family:system-ui,sans-serif; background:#1e1e2f; color:#f0f0f0; }
    .navbar { background:#27293d; position:fixed;top:0;left:0;right:0;z-index:1000;box-shadow:0 4px 8px rgba(0,0,0,0.1); }
    .navbar-brand { color:#f0f0f0; }
    .navbar-toggler { border-color:rgba(255,255,255,0.4); }
    .navbar-toggler-icon { filter:invert(1); }
    .wrapper { display:flex; flex-direction:column; }
    @media(min-width:992px){ .wrapper { flex-direction:row; } }
    .sidebar { background:#2c2f48; border-bottom:1px solid #333; }
    @media(min-width:992px){
      .sidebar { position:sticky; top:56px; height:calc(100vh-56px); width:250px; border-right:1px solid #333; overflow-y:auto; }
    }
    .sidebar .nav-link { color:#ccc; margin:.5rem 0; }
    .sidebar .nav-link.active,
    .sidebar .nav-link:hover { background:#3e4161; color:#fff; border-radius:5px; }
    .main-content { flex-grow:1; padding:20px; background:#1e1e2f; }
    .card { background:#2a2d45; border:none; color:#fff; }
    .btn-primary { background:#5c6bc0; border-color:#5c6bc0; color:#fff; }
    .btn-primary:hover { background:#3f51b5; border-color:#3f51b5; }
    .fixed-width-badge { display:inline-block; width:100px; text-align:center; }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg px-4">
    <a class="navbar-brand text-white" href="index.html">全局设定</a>
    <button
      class="navbar-toggler ms-auto"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#sidebarMenu"
      aria-controls="sidebarMenu"
      aria-expanded="false"
      aria-label="Toggle sidebar"
      id="sidebarToggle"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
  </nav>

  <div class="wrapper">
    <div class="sidebar collapse d-lg-block" id="sidebarMenu">
      <nav class="nav flex-column px-3 pt-4">
        <a class="nav-link" href="admin-dashboard.html"><i class="bi bi-speedometer2 me-2"></i>控制面板</a>
        <a class="nav-link" href="/admin-user.html"><i class="bi bi-box-seam me-2"></i>用户管理</a>
        <a class="nav-link" href="/admin-task.html"><i class="bi bi-box-seam me-2"></i>任务模版</a>
        <a class="nav-link" href="/admin-order.html"><i class="bi bi-box-seam me-2"></i>订单管理</a>
        <a class="nav-link" href="/admin-transaction.html"><i class="bi bi-bank me-2"></i>交易明细</a>
        <a class="nav-link active" href="/admin-setting.html"><i class="bi bi-receipt me-2"></i>全局设定</a>
        <a class="nav-link" href="#" onclick="Logout()"><i class="bi bi-box-arrow-right me-2"></i>登出</a>
      </nav>
    </div>

    <div class="main-content">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">全局设定</h3>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table class="table table-dark table-hover align-middle mb-0">
            <thead>
              <tr>
                <th style="min-width:100px">键名</th>
                <th>键值</th>
                <th style="min-width:75px">操作</th>
              </tr>
            </thead>
            <tbody id="configTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/index.html';
      window.stop()
    }
    
    const decoded = jwt_decode(token);
    if (decoded.exp < Date.now()/1000 || decoded.userType !== 0) {
      localStorage.removeItem('token');
      window.location.href = '/index.html';
      window.stop()
    }

    async function loadConfig() {
      const configLabels = {
        blocker_indexes: '卡单位置',
        commission_rate: '佣金比例',
        cycle_size: '任务环数'
      };

      const res = await axios.get('/config', { headers:{Authorization:`Bearer ${token}`} });
      const tbody = document.getElementById('configTableBody');
      tbody.innerHTML = '';

      res.data.data.forEach(row => {
        const label = configLabels[row.key] || row.key; // 没有翻译的就显示原 key
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${label}</td>
          <td><input type="text" class="form-control" value="${row.value}" data-key="${row.key}"></td>
          <td><button class="btn btn-sm btn-primary save-config" data-key="${row.key}">保存</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function saveConfig(key) {
      const value = document.getElementById(`val-${key}`).value;
      await axios.post(`/api/config/${encodeURIComponent(key)}`, { value });
      loadConfig();
    }

    loadConfig();
    
    function Logout() {
      localStorage.removeItem('token');
      window.location.href = '/index.html';
    };
  </script>
</body>
</html>
