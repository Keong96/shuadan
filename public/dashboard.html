<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="localization.js" defer></script>
  <style>
    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
    }
    html, body {
      height:100%;
      font-family:sans-serif;
      background: linear-gradient(90deg,#eef2f5 0%,#cfe9ff 100%);
      padding-top:20px;
    }
    .tab, .card {
      width:85%;
      margin:12px auto;
      border-radius:1rem;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
      border:none;
    }
    .card-body { 
      padding:16px;
    }
    h5 {
      margin-bottom:12px;
      color:#333;
      font-weight:600;
    }
    .btn, input, select {
      border-radius:1.5rem !important;
    }
    input, select { 
      background:#f7f9fa;
      border:none;
      padding-left:3rem;
      height:48px;
    }
    .input-icon { 
      position:absolute;
      left:1rem;
      top:50%;
      transform:translateY(-50%);
      color:#888;
      font-size:1.2rem;
    }
    .btn-wide {
      width:100%;
      max-width:360px;
      margin-top:12px;
    }
    .bottom-nav { 
      position:fixed;
      bottom:0;
      width:100%;
      height:60px;
      background:#fff;
      display:flex;
    }
    .bottom-nav button { 
      flex:1;
      background:none;
      border:none;
      font-size:14px;
      color:#888;
    }
    .bottom-nav button.active {
      color:#49c140;
      font-weight:bold;
    }
    #carousel {
      width: 85%;
      height: 250px;
      margin: 24px auto 16px;
      border-radius: 1rem;
      overflow: hidden;
    }
    #carousel .carousel-inner,
    #carousel .carousel-item,
    #carousel img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    section {
      min-height: calc(100dvh - 60px);
      overflow-y: auto;
      padding-bottom: 80px;
    }
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #222;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
      margin-bottom: 12px;
    }
    video {
      display: block;
      border: none;
      outline: none;
      margin: 0;
      box-shadow: 0 0 0 1px transparent;
      background: #fff;
    }
    .custom-select-wrapper {
      width: 320px;
      margin-bottom: 1rem;
      position: relative;
      user-select: none;
    }
    .custom-select-trigger {
      background: #f7f9fa;
      border-radius: 1.5rem;
      padding: 0.75rem 1rem 0.75rem 3rem;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }
    .custom-select-options {
      position: absolute;
      top: calc(100% + 0.25rem);
      left: 0;
      width: 100%;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: none;
      list-style: none;
      margin: -0.75rem 0 0 0;
      z-index: 999;
    }
    .custom-select-options.show {
      display: block;
    }
    .custom-select-options li {
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-size: .9rem;
    }
    .custom-select-options li:hover {
      background: #f1f1f1;
    }
  </style>
</head>
<body>
  <div id="mainContent">
    <!-- Section 1: Home -->
    <section id="section-home">
      <!-- Carousel -->
      <div id="carousel" class="carousel slide mt-3" data-bs-ride="carousel" data-bs-interval="3000">
        <div class="carousel-inner rounded-4 overflow-hidden">
          <div class="carousel-item active">
            <img src="https://img.pikbest.com/templates/20240815/shopping-banner-design_10726461.jpg!w700wp" class="d-block w-100" alt="Promo 1">
          </div>
          <div class="carousel-item">
            <img src="https://i.pinimg.com/736x/ed/cd/32/edcd32b829a5c6e614a6d6383c562742.jpg" class="d-block w-100" alt="Promo 2">
          </div>
          <div class="carousel-item">
            <img src="https://previews.123rf.com/images/mikalaimanyshau/mikalaimanyshau1601/mikalaimanyshau160100083/50304057-colourful-shopping-vector-flat-banner-for-your-business-web-sites-etc-quality-design-illustrations.jpg" class="d-block w-100" alt="Promo 2">
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carousel" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>
      </div>

      <!-- Announcement -->
      <div class="card mb-3">
        <div class="card-body text-center" style="background: url('https://www.emarsysunivip.com/static/images/home-bg.png') center center/cover no-repeat";>
          <div class="text-one" data-i18n="section.home.announcement.title"><b>Ecommerce Development Company</b></div>
          <div class="text-two" data-i18n="section.home.announcement.subtitle">Unlock New eCommerce Opportunities with Emarsys</div>
          <div class="text-three" data-i18n="section.home.announcement.desc">Empowering Your Business with Innovative Solutions, Tailored Strategies, and Technical Excellence</div>
        </div>
      </div>

      <!-- Mission -->
      <div class="card mb-3">
        <div class="card-body text-center" style="background: url('https://www.emarsysunivip.com/static/images/home-bg.png') center center/cover no-repeat";>
          <h5 class="card-title" data-i18n="section.home.mission.title"><i class="bi bi-bullseye me-2"></i>Our Mission</h5>
          <p class="mb-0" data-i18n="section.home.mission.desc">Inspiring businesses to dream big and scale new horizons in the digital landscape, armed with our expertise, passion, and touch of gentle humor.</p>
        </div>
      </div>

      <!-- Expertise -->
      <div class="card mb-3">
        <div class="card-body text-center" style="background: url('https://www.emarsysunivip.com/static/images/home-bg.png') center center/cover no-repeat";>
          <h5 class="card-title" data-i18n="section.home.expertise.title"><i class="bi bi-bar-chart-line me-2"></i>Expertise in Numbers</h5>
          <div class="row">
            <div class="col-6"><strong>100+</strong><br data-i18n="section.home.expertise.clients">Clients</div>
            <div class="col-6"><strong>65+</strong><br data-i18n="section.home.expertise.team">Team Members</div>
            <div class="col-6 mt-3"><strong>9.3</strong><br data-i18n="section.home.expertise.nps">Customer NPS</div>
            <div class="col-6 mt-3"><strong>150+</strong><br data-i18n="section.home.expertise.projects">Projects</div>
          </div>
        </div>
      </div>

      <!-- Services -->
      <div class="card mb-3">
        <div class="card-body text-center" style="background: url('https://www.emarsysunivip.com/static/images/home-bg.png') center center/cover no-repeat";>
          <h5 class="card-title" data-i18n="section.home.services.title"><i class="bi bi-gear-fill me-2"></i>Our Services</h5>
          <ul class="ps-3 mb-0">
            <li data-i18n="section.home.services.item1"><strong>E-commerce End-to-End:</strong> From start-up to scale-up, we’re with you at every phase.</li>
            <li class="mt-2" data-i18n="section.home.services.item2"><strong>Custom Development:</strong> Tailored solutions that bring your vision to life.</li>
            <li class="mt-2" data-i18n="section.home.services.item3"><strong>Developers for Hire:</strong> Reinforce your team with Smartosc experts.</li>
            <li class="mt-2" data-i18n="section.home.services.item4"><strong>Mobile Development:</strong> Build innovative apps that captivate users.</li>
          </ul>
        </div>
      </div>

      <!-- Testimonials -->
      <div id="testimonialCarousel" class="carousel slide mb-3" data-bs-ride="carousel" data-bs-interval="3000">
        <div class="carousel-inner rounded-4 overflow-hidden" style="width: 85%; margin: 0 auto; background: #fff;">
          <div class="carousel-item active text-center p-4">
            <h5 class="card-title" data-i18n="section.home.testimonials.title"><i class="bi bi-chat-dots-fill me-2"></i>Customer Reviews</h5>
            <p data-i18n="section.home.testimonials.review1.text">"Working with this team was a game changer! Reliable, creative, and always one step ahead."</p>
            <div class="text-warning fs-5">★★★★★</div>
            <small class="text-muted d-block mt-2" data-i18n="section.home.testimonials.review1.author">— Jane L., CEO of BrightCommerce</small>
          </div>
          <div class="carousel-item text-center p-4">
            <h5 class="card-title" data-i18n="section.home.testimonials.title"><i class="bi bi-chat-dots-fill me-2"></i>Customer Reviews</h5>
            <p data-i18n="section.home.testimonials.review2.text">"They helped us scale fast without compromising quality. Great communication and dedication."</p>
            <div class="text-warning fs-5">★★★★½</div>
            <small class="text-muted d-block mt-2" data-i18n="section.home.testimonials.review2.author">— Marcus T., Ops Manager at Sellify</small>
          </div>
          <div class="carousel-item text-center p-4">
            <h5 class="card-title" data-i18n="section.home.testimonials.title"><i class="bi bi-chat-dots-fill me-2"></i>Customer Reviews</h5>
            <p data-i18n="section.home.testimonials.review3.text">"Smart, professional, and quick to deliver. Highly recommend their team to anyone needing results."</p>
            <div class="text-warning fs-5">★★★★★</div>
            <small class="text-muted d-block mt-2" data-i18n="section.home.testimonials.review3.author">— Aisha K., Founder of NovaKart</small>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 2: Funds -->
    <section id="section-funds" class="d-none px-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold text-primary">
          <i class="bi bi-list-columns-reverse me-1"></i>
          <span data-i18n="funds.transaction.title">Transaction History</span>
        </h6>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#withdrawModal">
          <i class="bi bi-download me-1"></i>
          <span data-i18n="funds.withdraw.title">Withdraw</span>
        </button>
      </div>

      <!-- Scrollable Table -->
      <div style="overflow-y: auto;">
        <table class="table table-sm table-striped table-hover text-center align-middle mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th>ID</th>
              <th data-i18n="funds.transaction.date">Date</th>
              <th data-i18n="funds.transaction.type">Type</th>
              <th data-i18n="funds.transaction.amount">Amount</th>
              <th data-i18n="funds.transaction.status">Status</th>
              <th data-i18n="funds.transaction.remark">Remark</th>
            </tr>
          </thead>
          <tbody id="transactionTableBody">
            <tr><td colspan="4" class="text-muted" data-i18n="funds.transaction.loading">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Section 3: Tasks -->
    <section id="section-tasks" class="d-none">
      <div class="card mb-3 position-relative">
        <button class="btn btn-light p-1 rounded-circle position-absolute top-0 end-0 m-2"
                data-bs-toggle="modal" data-bs-target="#infoModal"
                data-i18n="tasks.info.button" title="Info">
          <i class="bi bi-question-circle"></i>
        </button>
        <div style="border-radius: 1rem; overflow: hidden;">
          <video autoplay muted loop playsinline style="width: 100%; display: block;">
            <source src="https://www.emarsysunivip.com/static/images/video.mp4" type="video/mp4">
          </video>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body text-center">
          <h5 class="card-title mb-3">
            <i class="bi bi-list-check me-2"></i>
            <span data-i18n="tasks.title">Task Overview</span>
          </h5>
          <div class="row mb-3">
            <div class="col-6 mb-3">
              <i class="bi bi-wallet2 text-primary"></i><br>
              <strong id="balanceAmount">$0.00</strong><br>
              <span data-i18n="tasks.balance">Balance</span>
            </div>
            <div class="col-6 mb-3">
              <i class="bi bi-graph-up-arrow text-success"></i><br>
              <strong id="dailyProfit">$0.00</strong><br>
              <span data-i18n="tasks.dailyProfit">Daily Profit</span>
            </div>
            <div class="col-6">
              <i class="bi bi-check2-circle text-info"></i><br>
              <strong id="taskQty">0</strong><br>
              <span data-i18n="tasks.completed">Tasks Completed</span>
            </div>
            <div class="col-6">
              <i class="bi bi-percent text-warning"></i><br>
              <strong id="completionRatio">0/0</strong><br>
              <span data-i18n="tasks.completion">Completion</span>
            </div>
          </div>
          <button id="btnOptimize" class="btn btn-primary btn-wide" data-bs-toggle="modal" data-bs-target="#taskModal" data-i18n="tasks.optimize" onclick="takeOrder()">Optimize</button>
          <button id="btnClaimComm" class="btn btn-success btn-wide d-none" data-bs-toggle="modal" data-bs-target="#commModal" data-i18n="tasks.claimComm">Claim Commission</button>
        </div>
      </div>

      <div class="alert alert-light d-flex align-items-start mt-3 mx-3" role="alert">
        <i class="bi bi-bell-fill text-primary fs-4 me-2"></i>
        <div>
          <div class="fw-bold" data-i18n="tasks.notice.title">Important Notice</div>
          <div data-i18n="tasks.notice.hours">Business hour 10:00 AM – 10:00 PM</div>
          <small class="text-muted" data-i18n="tasks.notice.support">For inquiries about applicants, please refer to the support team.</small>
        </div>
      </div>
    </section>

    <!-- Section 4: Records -->
    <section id="section-records" class="d-none">
      <h5 class="mb-3 px-3">
        <i class="bi bi-clock-history me-2"></i>
        <span data-i18n="records.title">Task Records</span>
      </h5>
    </section>

    <!-- Section 5: Profile -->
    <section id="section-profile" class="d-none">
      <!-- Profile Card -->
      <div class="card mb-3">
        <div class="card-body text-center">
          <i class="bi bi-person-circle mb-2" style="font-size: 60px;"></i>
          <h6 class="fw-bold">技术账号（请勿删除）51</h6>
          <div class="badge bg-warning text-dark mb-2">VIP 2</div>

          <div class="d-flex justify-content-center align-items-center gap-1 mb-1">
            <i class="bi bi-star-fill" style="font-size: 16px; color: #FFC107;"></i>
            <i class="bi bi-star-fill" style="font-size: 16px; color: #FFC107;"></i>
            <i class="bi bi-star-fill" style="font-size: 16px; color: #FFC107;"></i>
            <i class="bi bi-star-fill" style="font-size: 16px; color: #FFC107;"></i>
            <i class="bi bi-star-fill" style="font-size: 16px; color: #FFC107;"></i>
            <span class="ms-2 small">100 / 100</span>
          </div>
          <small class="text-muted d-block" data-i18n="profile.starHint">1 star represents 20 points of credit score</small>
        </div>
      </div>

      <!-- Info Blocks -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <div data-i18n="profile.email"><i class="bi bi-envelope-fill me-2"></i><span>Email</span></div>
            <div id="profileEmail">test@email.com</div>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <div data-i18n="profile.gender"><i class="bi bi-gender-ambiguous me-2"></i><span>Gender</span></div>
            <div id="profileGender">Other</div>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <div data-i18n="profile.dob"><i class="bi bi-calendar-event-fill me-2"></i><span>Date of Birth</span></div>
            <div id="profileDob">1990-01-01</div>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <div data-i18n="profile.assetBalance"><i class="bi bi-wallet2 me-2"></i><span>Asset Balance</span></div>
            <div id="profileBalance">0.00 USD</div>
          </div>
          <div class="d-flex justify-content-between">
            <div data-i18n="profile.dailyProfit"><i class="bi bi-cash-stack me-2"></i><span>Daily Profit</span></div>
            <div id="profileProfit">0.00 USD</div>
          </div>
        </div>
      </div>

      <!-- Invitation Programme -->
      <div class="card mb-3">
        <div class="card-body text-center">
          <h5 class="card-title" data-i18n="profile.inviteTitle">Invitation Programme</h5>
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <span data-i18n="profile.inviteCode">Invitation Code:</span>
              <span id="inviteCode" class="fw-bold">ABCDEF</span>
            </div>
            <button id="copyInviteBtn" class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="popover" data-bs-trigger="manual" data-bs-placement="top" data-bs-content="Copied!" data-bs-custom-class="bg-success text-white">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <div class="row justify-content-center mt-3">
            <div class="col-9">
              <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#teamModal" data-i18n="profile.viewTeam">View Team</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div class="card mb-3">
        <div class="card-body text-center">
          <h5 class="card-title" data-i18n="profile.settings">Settings</h5>
          <div class="row g-2">
            <!-- Security Center -->
            <div class="col-4">
              <button type="button" class="btn btn-light w-100 py-3" data-bs-toggle="modal" data-bs-target="#securityModal">
                <i class="bi bi-shield-lock mb-1 d-block"></i>
                <small data-i18n="profile.securityCenter">Security Center</small>
              </button>
            </div>
            <!-- Withdraw Detail -->
            <div class="col-4">
              <button type="button" class="btn btn-light w-100 py-3" data-bs-toggle="modal" data-bs-target="#withdrawInfoModal">
                <i class="bi bi-file-earmark-text mb-1 d-block"></i>
                <small data-i18n="profile.withdrawInfo">Withdrawal Infomation</small>
              </button>
            </div>
            <!-- Language -->
            <div class="col-4">
              <button type="button" class="btn btn-light w-100 py-3" data-bs-toggle="modal" data-bs-target="#languageModal">
                <i class="bi bi-translate mb-1 d-block"></i>
                <small data-i18n="profile.language">Language</small>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Logout -->
      <div class="row justify-content-center mb-3">
        <div class="col-9">
          <button class="btn btn-danger w-100" data-i18n="profile.signOut" onclick="Logout()">
            Sign Out
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button onclick="switchSection('home')" data-i18n="nav.home"><i class="bi bi-house-door-fill"></i><br>Home</button>
    <button onclick="switchSection('funds')" data-i18n="nav.funds"><i class="bi bi-wallet2"></i><br>Funds</button>
    <button onclick="switchSection('tasks')" data-i18n="nav.tasks"><i class="bi bi-list-check"></i><br>Tasks</button>
    <button onclick="switchSection('records')" data-i18n="nav.records"><i class="bi bi-clock-history"></i><br>Records</button>
    <button onclick="switchSection('profile')" data-i18n="nav.profile"><i class="bi bi-person-circle"></i><br>Profile</button>
  </nav>

  <!-- Withdraw Modal -->
  <div class="modal fade" id="withdrawModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">

        <div class="modal-header border-bottom">
          <h5 class="modal-title fw-semibold" data-i18n="funds.withdraw.title">Withdraw</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body px-4 py-3">
          <label class="small text-muted" data-i18n="funds.withdraw.label">Withdrawable Amount</label>
          <h3 id="withdrawableAmount" class="mb-3 text-primary">$0.00</h3>

          <form id="withdrawForm">
            <input type="number" step="0.01" class="form-control mb-2"
              data-i18n-placeholder="funds.withdraw.placeholder.amount" required>

            <div class="form-control mb-2 bg-light rounded-4">
              <span class="text-muted small d-block" data-i18n="funds.withdraw.receivingAccount">Receiving Account:</span>
              <span id="linkedAccount" class="fw-bold">+123456789</span>
            </div>

            <input type="password" class="form-control mb-3" maxlength="6"
              data-i18n-placeholder="funds.withdraw.placeholder.pin" required>

            <button type="button" class="btn btn-primary w-100" onclick="submitWithdraw()">
              <i class="bi bi-cash-stack me-1"></i>
              <span data-i18n="funds.withdraw.submit">Submit Withdrawal</span>
            </button>
          </form>

          <small class="text-muted d-block mt-2" data-i18n="funds.withdraw.note">
            * Withdrawals require task completion and service fee.
          </small>
        </div>

      </div>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow">

        <!-- Header -->
        <div class="modal-header border-bottom">
          <h5 class="modal-title fw-semibold" data-i18n="modal.task.title">Submit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- Body -->
        <div class="modal-body px-4 py-4">

          <!-- Image -->
          <div class="text-center mb-4">
            <img id="taskImage" src="" class="img-fluid rounded shadow-sm border"
              style="max-height: 180px; object-fit: cover;" alt="Product Image">
          </div>

          <!-- Product Info -->
          <div class="text-center mb-3">
            <h5 id="taskProductName" class="fw-bold mb-1" data-i18n="modal.task.productName">Product Name</h5>
            <p id="taskDescription" class="text-muted small mb-0 px-3" data-i18n="modal.task.description">
              This is a sample description for the task.
            </p>
          </div>

          <!-- Amount Info -->
          <div class="row text-center mb-4">
            <div class="col-6">
              <div class="border rounded p-3 bg-light">
                <div class="text-muted small" data-i18n="modal.task.priceLabel">Price</div>
                <div id="taskPrice" class="fw-bold fs-5 text-primary">$0.00</div>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-3 bg-light">
                <div class="text-muted small" data-i18n="modal.task.commissionLabel">Commission</div>
                <div id="taskCommission" class="fw-bold fs-5 text-success">$0.00</div>
              </div>
            </div>
          </div>

          <!-- Rating -->
          <div class="text-center mb-4">
            <div class="text-muted small mb-1" data-i18n="modal.task.ratingLabel">Your Rating</div>
            <div class="d-flex justify-content-center gap-1">
              <span class="star text-warning fs-4" data-value="1">&#9734;</span>
              <span class="star text-warning fs-4" data-value="2">&#9734;</span>
              <span class="star text-warning fs-4" data-value="3">&#9734;</span>
              <span class="star text-warning fs-4" data-value="4">&#9734;</span>
              <span class="star text-warning fs-4" data-value="5">&#9734;</span>
            </div>
          </div>

          <!-- Comment Select -->
          <div class="mb-4 text-start">
            <label class="form-label small text-muted d-block mb-2" data-i18n="modal.task.comment.choose">Choose a comment</label>
            <div class="custom-select-wrapper">
              <div class="custom-select-trigger">Choose a comment</div>
              <ul class="custom-select-options" id="customSelectOptions">
                <li value="fast" data-i18n="comment.option.fast">Great product, fast delivery!</li>
                <li value="money" data-i18n="comment.option.value">Good value for money.</li>
                <li value="quality" data-i18n="comment.option.quality">High quality, recommended.</li>
                <li value="custom" data-i18n="comment.option.custom">Other...</li>
              </ul>
            </div>
          </div>

          <!-- Custom Comment -->
          <div class="mb-4 d-none" id="customCommentWrap">
            <input type="text" class="form-control" id="customComment"
              data-i18n-placeholder="modal.task.comment.placeholder" placeholder="">
          </div>

          <div id="taskModalErrorMsg" class="text-danger mb-2 d-none">
            <b>You dont have enough balance to complete this order.</b>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer bg-light p-3 border-top">
          <button class="btn btn-success w-100 fw-semibold"
            onclick="submitReview()" data-i18n="modal.task.submit">
            Submit Review
          </button>
        </div>

        <!-- Success Msg -->
        <div id="taskSuccessMessage" class="text-center py-5">
          <i class="bi bi-check-circle-fill text-success fs-1 mb-3"></i>
          <h5 class="fw-bold text-success" data-i18n="modal.task.completed"></h5>
          <p class="text-muted" data-i18n="modal.task.completedNote"></p>
          <button class="btn btn-success mt-3 px-4" data-bs-dismiss="modal" data-i18n="modal.task.doneBtn"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Commission Modal -->
  <div class="modal fade" id="commModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow border-0">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n="commModal.title">Claim Commission</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <div class="mb-3">
            <i class="bi bi-check-circle-fill text-success fs-1 mb-2"></i>
            <h5 data-i18n="commModal.cycleComplete">You have completed your current cycle!</h5>
            <p class="text-muted" data-i18n="commModal.details">Completed Tasks: <strong id="completedTasks">0/20</strong></p>
          </div>
          <div class="border-top pt-3 mt-2">
            <span data-i18n="commModal.message">Total commission to claim:</span>
            <div class="fs-4 fw-bold text-success" id="commissionAmount">$0.00</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="commModal.cancel">Cancel</button>
          <button type="button" class="btn btn-success" onclick="claimCommission()" data-i18n="commModal.confirm">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold" id="infoModalLabel" data-i18n="modal.info.title">Info</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- Daily Profit -->
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-wallet2 me-2 fs-4 text-primary"></i>
            <p class="mb-0" data-i18n="modal.info.dailyProfit.question">What is Daily Profit?</p>
          </div>
          <div class="mb-3 text-muted" data-i18n="modal.info.dailyProfit.answer">
            System will automatically calculate your daily profit
          </div>

          <!-- Asset Balance -->
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-cash-stack me-2 fs-4 text-success"></i>
            <p class="mb-0" data-i18n="modal.info.assetBalance.question">What is Asset Balance?</p>
          </div>
          <div class="mb-3 text-muted" data-i18n="modal.info.assetBalance.answer">
            Earning will automatically be added to balance
          </div>

          <!-- On Hold -->
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-cash-coin me-2 fs-4 text-warning"></i>
            <p class="mb-0" data-i18n="modal.info.onHold.question">What is On-Hold?</p>
          </div>
          <div class="mb-3 text-muted" data-i18n="modal.info.onHold.answer">
            The amount will be put on hold temporarily and the balance can be turned after completion
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- View Team Modal -->
  <div class="modal fade" id="teamModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n="modal.team.title">Your Team</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-center gap-3 mb-3">
            <span class="badge bg-primary fs-5 py-2 px-3" id="totalSalesBadge">
              <span data-i18n="modal.team.totalSales"></span> <br><br> $471.25
            </span>
            <span class="badge bg-success fs-5 py-2 px-3" id="totalCommissionBadge">
              <span data-i18n="modal.team.totalCommission"></span> <br><br> $47.13
            </span>
          </div>
          <table class="table table-striped text-center">
            <thead>
              <tr>
                <th data-i18n="modal.team.username">Username</th>
                <th data-i18n="modal.team.sales">Sales</th>
                <th data-i18n="modal.team.commission">Commission</th>
              </tr>
            </thead>
            <tbody id="teamTableBody">
              <tr><td>user001</td><td>$128.50</td><td>$12.85</td></tr>
              <tr><td>user002</td><td>$300.00</td><td>$30.00</td></tr>
              <tr><td>user003</td><td>$42.75</td><td>$4.28</td></tr>
              <tr><td>user004</td><td>$0.00</td><td>$0.00</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Security Modal -->
  <div class="modal fade" id="securityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n="modal.security.title">Security Center</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="securityForm">
            <div class="mb-3">
              <label for="oldPassword" class="form-label" data-i18n="modal.security.old_password">Old Password</label>
              <input type="password" id="oldPassword" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="newPassword" class="form-label" data-i18n="modal.security.new_password">New Password</label>
              <input type="password" id="newPassword" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="confirmPassword" class="form-label" data-i18n="modal.security.confirm_password">Confirm Password</label>
              <input type="password" id="confirmPassword" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="securityPin" class="form-label" data-i18n="modal.security.pin">Security PIN</label>
              <input type="password" id="securityPin" class="form-control" maxlength="6" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="submit" form="securityForm" class="btn btn-primary w-100" data-i18n="modal.security.save">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Withdraw Info Modal -->
  <div class="modal fade" id="withdrawInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n="modal.withdraw.title">Withdrawal Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="withdrawInfoForm">
            <div class="mb-3">
              <label class="form-label" data-i18n="modal.withdraw.full_name">Full Name</label>
              <input type="text" class="form-control bg-grey" readonly disabled>
            </div>
            <div class="mb-3">
              <label class="form-label" data-i18n="modal.withdraw.wallet_or_phone">Wallet Address / Phone No.</label>
              <input type="text" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label" data-i18n="modal.withdraw.security_password">Security Pin</label>
              <input type="password" class="form-control" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="UpdateProfile()" class="btn btn-primary w-100" data-i18n="modal.withdraw.save">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Language Modal -->
  <div class="modal fade" id="languageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n="modal.language.title">Select Language</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group">
            <li class="list-group-item language-option" data-lang="en" data-i18n="modal.language.english">English</li>
            <li class="list-group-item language-option" data-lang="zh" data-i18n="modal.language.chinese">中文</li>
            <li class="list-group-item language-option" data-lang="es" data-i18n="modal.language.spanish">Español</li>
            <li class="list-group-item language-option" data-lang="fr" data-i18n="modal.language.french">Français</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if(!token)
    {
      window.stop();
      window.location.href = `${window.location.origin}/index.html`;
    }

    const decoded_token = jwt_decode(token);
    if (decoded_token.exp < Math.floor(Date.now()/1000))
    {
      window.stop();
      localStorage.removeItem("token");
      window.location.href = `${window.location.origin}/index.html`;
    }

    function switchSection(section) {
      ['home', 'funds', 'tasks', 'records', 'profile'].forEach(id => {
        document.getElementById('section-' + id).classList.add('d-none');
      });
      document.getElementById('section-' + section).classList.remove('d-none');

      document.querySelectorAll('.bottom-nav button').forEach(btn => btn.classList.remove('active'));
      Array.from(document.querySelectorAll('.bottom-nav button'))
        .find(btn => btn.getAttribute('onclick').includes(section))
        ?.classList.add('active');

      // Section-specific hooks
      switch (section) {
        case 'home':
          break;
        case 'funds':
          loadTransactions();
          break;
        case 'tasks':
          refreshUserProfile();
          break;
        case 'records':
          loadTaskRecord();
          break;
        case 'profile':
          break;
        default:
          break;
      }
    }

    async function loadTransactions() {
      const tbody = document.getElementById('transactionTableBody');
      tbody.innerHTML = `<tr><td colspan="6" class="text-muted">Loading...</td></tr>`;

      try {
        const { data } = await axios.get(`${window.location.origin}/my-transactions`, {
          headers: {
            Authorization: `Bearer ${token}`,
            'Accept-Language': localStorage.getItem('lang') || 'en'
          }
        });

        if (!data.status || !Array.isArray(data.data)) throw new Error();

        const transactions = data.data;

        if (transactions.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-muted">No transactions found.</td></tr>`;
          return;
        }

        tbody.innerHTML = '';
        transactions.forEach(tx => {
          const amount = parseFloat(tx.amount) || 0;

          const typeClassMap = {
            purchase: 'bg-primary',
            commission: 'bg-info',
            withdrawal: 'bg-secondary',
            deposit: 'bg-success',
            bonus: 'bg-warning',
            adjustment: 'bg-dark'
          };

          const statusClassMap = {
            pending: 'bg-warning text-dark',
            approved: 'bg-success',
            rejected: 'bg-danger',
            failed: 'bg-danger'
          };

          const typeClass = typeClassMap[tx.type.toLowerCase()] || 'bg-secondary';
          const statusClass = statusClassMap[tx.status.toLowerCase()] || 'bg-secondary';

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${tx.id}</td>
            <td>${new Date(tx.created_at).toLocaleString()}</td>
            <td><span class="badge ${typeClass}">${tx.type_label}</span></td>
            <td class="${amount >= 0 ? 'text-success' : 'text-danger'}">${amount.toFixed(2)}</td>
            <td><span class="badge ${statusClass}">${tx.status_label}</span></td>
            <td>${tx.remark || '-'}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-danger">Error loading transactions</td></tr>`;
        console.error('loadTransactions error:', err);
      }
    }

    async function takeOrder() {
      const modalEl    = document.getElementById('taskModal');
      const imgEl      = modalEl.querySelector('#taskImage');
      const nameEl     = modalEl.querySelector('#taskProductName');
      const descEl     = modalEl.querySelector('#taskDescription');
      const priceEl    = modalEl.querySelector('#taskPrice');
      const comEl      = modalEl.querySelector('#taskCommission');
      const stars      = modalEl.querySelectorAll('.star');
      const customWrap = modalEl.querySelector('#customCommentWrap');
      const customIn   = modalEl.querySelector('#customComment');
      const trigger    = modalEl.querySelector('.custom-select-trigger');
      const submitBtn  = modalEl.querySelector('.btn-success');
      const errMsg     = document.getElementById('taskModalErrorMsg');
      const bsModal    = bootstrap.Modal.getOrCreateInstance(modalEl);

      const successEl = modalEl.querySelector('#taskSuccessMessage');

      if (successEl)
        successEl.classList.add('d-none');

      Array.from(modalEl.querySelector('.modal-body').children).forEach(child => {
        if (child !== successEl && child !== errMsg)
          child.classList.remove('d-none');
      });

      modalEl.querySelector('.modal-footer')?.classList.remove('d-none');

      try {
        const { data } = await axios.post(`${window.location.origin}/orders`, {},
        {
          headers: {
            Authorization: `Bearer ${token}`,
            'Accept-Language': localStorage.getItem('lang') || 'en'
          }
        });
        
        if (!data.status) throw new Error(data.message || 'Order failed');

        const { orderId, amount, commission, productName, productDescription, productImage } = data.data;

        imgEl.src               = productImage;
        nameEl.innerText        = productName;
        descEl.innerText        = productDescription;
        priceEl.innerText       = `$${parseFloat(amount).toFixed(2)}`;
        comEl.innerText         = `$${parseFloat(commission).toFixed(2)}`;
        modalEl.dataset.orderId = orderId;

        stars.forEach(s => s.innerHTML = '☆');
        customWrap.classList.add('d-none');
        customIn.value = '';

        stars.forEach(s => {
          if (parseInt(s.dataset.value, 10) <= 3) s.innerHTML = '★';
        });
        
        if (trigger)
          trigger.innerHTML = 'Choose a comment <i class="bi bi-chevron-down float-end"></i>';

        const firstLi = modalEl.querySelector('.custom-select-options li');
        if (firstLi) {
          trigger.innerHTML = firstLi.textContent.trim() + ' <i class="bi bi-chevron-down float-end"></i>';
          trigger.dataset.value = firstLi.getAttribute('value') || '';
        }

        const balText = document.getElementById('balanceAmount').innerText;
        const balance = parseFloat(balText.replace(/[^0-9.]/g, ''));
        if (isNaN(balance)) return alert('Cannot read your balance.');

        if (amount > balance) {
          errMsg.classList.remove('d-none');
          submitBtn.disabled = true;
        }

        bsModal.show();
      } catch (err) {
        console.error('takeOrder error:', err);
        alert(err.response?.data?.message || 'Unable to fetch a new task.');
        bsModal.hide();
      }
    }
    
    async function submitReview() {
      const modalEl = document.getElementById('taskModal');
      const orderId = modalEl.getAttribute('data-order-id');
      const errMsg  = document.getElementById('taskModalErrorMsg');
      const submitBtn  = modalEl.querySelector('.btn-success');
      
      if (!orderId) return alert('Order ID missing.');

      let rating = 0;
      modalEl.querySelectorAll('.star').forEach(s => {
        if (s.innerHTML === '★') {
          rating = Math.max(rating, parseInt(s.dataset.value, 10));
        }
      });
      if (!rating) {
        errMsg.innerText = 'Please select a rating.';
        errMsg.classList.remove('d-none');
        submitBtn.disabled = true;
        return;
      }

      const trigger = modalEl.querySelector('.custom-select-trigger');
      let comment = trigger ? trigger.textContent.trim() : '';
      const customWrap = modalEl.querySelector('#customCommentWrap');
      const customInput = modalEl.querySelector('#customComment');
      if (customWrap && !customWrap.classList.contains('d-none')) {
        comment = customInput.value.trim();
      }
      if (!comment || comment === 'Choose a comment') {
        errMsg.innerText = 'Please select or enter a comment.';
        errMsg.classList.remove('d-none');
        submitBtn.disabled = true;
        return;
      }

      await axios.post(`/orders/${orderId}/review`, { rating, comment },
      {
        headers: {
            Authorization: `Bearer ${token}`,
            'Accept-Language': localStorage.getItem('lang') || 'en'
          }
      });
      
      const body = modalEl.querySelector('.modal-body');
      const successEl = modalEl.querySelector('#taskSuccessMessage');

      Array.from(body.children).forEach(child => {
        if (child !== successEl) child.classList.add('d-none');
      });

      if (successEl)
        successEl.classList.remove('d-none');

      modalEl.querySelector('.modal-footer').classList.add('d-none');
      modalEl.addEventListener('hide.bs.modal', refreshUserProfile, { once: true });
    }
    
    function populateProfile(user) {
      document.getElementById('balanceAmount').innerText = `$${parseFloat(user.balance || 0).toFixed(2)}`;
      document.getElementById('dailyProfit').innerText = `$${parseFloat(user.daily_profit || 0).toFixed(2)}`;
      document.getElementById('taskQty').innerText = user.tasks_completed || 0
      document.getElementById('completionRatio').innerText = `${user.completion_ratio}`;
      
      const optimizeBtn = document.getElementById('btnOptimize');
      const claimBtn    = document.getElementById('btnClaimComm');

      const [completed, total] = (user.completion_ratio || '0/0').split('/').map(n => parseInt(n, 10));

      if (completed < total) {
        optimizeBtn.classList.remove('d-none');
        claimBtn.classList.add('d-none');
      } else {
        optimizeBtn.classList.add('d-none');
        claimBtn.classList.remove('d-none');
      }

      document.querySelector('#section-profile h6').innerText = user.username
      const vipBadge = document.querySelector('#section-profile .badge')
      vipBadge.innerText = `VIP ${user.vip_level || 0}`

      const starContainer = document.querySelector('#section-profile .d-flex.justify-content-center')
      const stars = Math.floor((user.credit_score || 0) / 20)
      starContainer.innerHTML = ''
      for (let i = 0; i < 5; i++) {
        const starIcon = document.createElement('i')
        starIcon.className = 'bi bi-star-fill'
        starIcon.style.fontSize = '16px'
        starIcon.style.color = i < stars ? '#FFC107' : '#DDD'
        starContainer.appendChild(starIcon)
      }
      const scoreSpan = document.createElement('span')
      scoreSpan.className = 'ms-2 small'
      scoreSpan.innerText = `${user.credit_score || 0} / 100`
      starContainer.appendChild(scoreSpan)

      document.getElementById('profileEmail').innerText = user.email || '-'
      document.getElementById('profileGender').innerText = user.gender || '-'
      document.getElementById('profileDob').innerText = user.dob || '-'
      document.getElementById('profileBalance').innerText = `${parseFloat(user.balance || 0).toFixed(2)} USD`
      document.getElementById('profileProfit').innerText = `${parseFloat(user.daily_profit || 0).toFixed(2)} USD`

      document.getElementById('inviteCode').innerText = user.referral_code || '-'

      const withdrawInfoModal = document.getElementById('withdrawInfoModal')
      const inputs = withdrawInfoModal.querySelectorAll('input')

      if (inputs.length >= 2) {
        inputs[0].value = user.username || ''
        inputs[1].value = user.phone || ''
        inputs[2].value = ''
      }
    }

    function UpdateProfile() {
      const form = document.getElementById('withdrawInfoForm')
      const contact = form.querySelector('input:nth-child(5)').value.trim()
      const securityPin = form.querySelector('input:nth-child(8)').value.trim()

      const token = localStorage.getItem('token')
      if (!securityPin) return alert('Security PIN is required')

      axios.post(`${window.location.origin}/update-profile`, {
        contact,
        securityPin
      }, {
        headers: {
            Authorization: `Bearer ${token}`,
            'Accept-Language': localStorage.getItem('lang') || 'en'
          }
      })
      .then(res => {
        if (res.data.status) {
          alert('Profile updated')
          bootstrap.Modal.getInstance(document.getElementById('withdrawInfoModal')).hide()
        } else {
          alert(res.data.message || 'Update failed')
        }
      })
      .catch(err => {
        console.error('/update-profile error:', err)
        alert('Server error')
      })
    }
    
    async function loadCommissionData(btn) {
    try {
      const res = await axios.post('/orders', {}, {
        headers: {
            Authorization: `Bearer ${token}`,
            'Accept-Language': localStorage.getItem('lang') || 'en'
          }
      });

      const pendingCommission = parseFloat(res.data?.data || 0);
      const formatted = `$${pendingCommission.toFixed(2)}`;

      document.getElementById('commissionAmount').innerText = formatted;
      btn.setAttribute('data-commission-amount', pendingCommission);
    } catch (err) {
      console.error('loadCommissionData error:', err);
      alert(err.response?.data?.message || 'Failed to load commission data.');
    }
  }

    async function loadTaskRecord() {
      const token = localStorage.getItem('token')
      const res = await axios.get(`${window.location.origin}/orders`, {
        headers: {
          Authorization: `Bearer ${token}`,
          'Accept-Language': localStorage.getItem('lang') || 'en'
        }
      })

      populateTaskRecord(res.data.data)
    }

    function populateTaskRecord(orders) {
      const section = document.getElementById('section-records')
      section.innerHTML = `
        <h5 class="mb-3 px-3">
          <i class="bi bi-clock-history me-2"></i>
          <span data-i18n="records.title">Task Records</span>
        </h5>
      `

      if (!orders.length) {
        section.innerHTML += `
          <div class="text-center text-muted small mt-4" data-i18n="records.empty">
            No more records.
          </div>`
        return
      }

      orders.forEach(o => {
        const pd = new Date(new Date(o.created_at).getTime() + 8*60*60*1000)
        const dateStr = pd.toLocaleString('en-GB', {
          hour12: false,
          timeZone: 'Asia/Singapore'
        })
        const amt     = parseFloat(o.amount).toFixed(2)
        const pct     = parseFloat(o.commission).toFixed(2)
        const commAmt = (parseFloat(o.amount) * pct/100).toFixed(2)
        const pending = o.status === 'PENDING'

        section.innerHTML += `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted">${dateStr}</small>
                ${
                  pending
                  ? `<div class="d-flex align-items-center text-warning fw-bold" style="font-size: 0.8rem;">
                      <i class="bi bi-hourglass-split me-1" style="font-size: 0.9rem;"></i>
                      <span data-i18n="records.pending">Pending</span>
                    </div>`
                  : `<div class="d-flex align-items-center text-success fw-bold" style="font-size: 0.8rem;">
                      <i class="bi bi-check-circle-fill me-1" style="font-size: 0.9rem;"></i>
                      <span data-i18n="records.completed">Completed</span>
                    </div>`
                }
              </div>
              <div class="d-flex align-items-center mb-2">
                <div class="me-3" style="
                  width: 50px;
                  height: 50px;
                  background-image: url('${o.image_url}');
                  background-size: cover;
                  border-radius: 5px;
                "></div>
                <div class="fw-bold">${o.product_name}</div>
              </div>
              <div class="d-flex justify-content-between small text-muted mb-1">
                <div data-i18n="records.order_amount">Order Amount</div>
                <div class="fw-bold text-dark">${amt} USD</div>
              </div>
              <div class="d-flex justify-content-between small text-muted mb-1">
                <div data-i18n="records.commission">Commission</div>
                <div class="fw-bold text-dark">${pct}%</div>
              </div>
              <div class="d-flex justify-content-between small text-muted mb-3">
                <div data-i18n="records.comm_amount">Comm Amount</div>
                <div class="fw-bold text-dark">${commAmt} USD</div>
              </div>
              ${
                pending
                ? `<button id="btnOptimize"
                          class="btn btn-sm btn-success w-100"
                          data-bs-toggle="modal"
                          data-bs-target="#taskModal"
                          data-i18n="records.review"
                          onclick="takeOrder()">
                    Review Now
                  </button>`
                : ``
              }
            </div>
          </div>`
      })

      applyTranslations();
    }

    async function submitWithdraw() {
      const form = document.getElementById('withdrawForm');
      const amount = parseFloat(form.querySelector('input[type="number"]').value);
      const pin = form.querySelector('input[type="password"]').value.trim();

      try {
        const res = await axios.post('/withdraw', { amount, pin }, {
          headers: {
            Authorization: `Bearer ${token}`,
            'Accept-Language': localStorage.getItem('lang') || 'en'
          }
        });

        if (res.data?.status) {
          bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
          switchSection("funds");
        } else {
          alert(res.data?.message || 'Withdrawal failed');
        }
      } catch (err) {
        alert(err.response?.data?.message || 'Server error');
      }
    }

    function Logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }

    const stars = document.querySelectorAll('.star');
    stars.forEach(star => {
      star.addEventListener('click', () => {
        const val = parseInt(star.getAttribute('data-value'));
        stars.forEach((s, i) => {
          s.innerHTML = i < val ? '★' : '☆';
        });
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      window.originalTaskModalHTML = document.querySelector('#taskModal .modal-body').innerHTML;

      loadTransactions();
      loadTaskRecord();
      refreshUserProfile();
      
      const trigger = document.querySelector('.custom-select-trigger');
      const options = document.querySelector('.custom-select-options');
      const customInputWrap = document.getElementById('customCommentWrap');
      const customInput = document.getElementById('customComment');

      if (!trigger || !options) return;

      trigger.addEventListener('click', e => {
        e.stopPropagation();
        options.classList.toggle('show');
      });

      options.querySelectorAll('li').forEach(li => {
        li.addEventListener('click', () => {
          const selectedText = li.textContent.trim();
          const selectedValue = li.getAttribute('value');

          trigger.innerHTML = selectedText + ' <i class="bi bi-chevron-down float-end"></i>';
          options.classList.remove('show');

          if (selectedValue === 'custom') {
            customInputWrap?.classList.remove('d-none');
            customInput?.focus();
          } else {
            customInputWrap?.classList.add('d-none');
            if (customInput) 
              customInput.value = '';
          }
        });
      });

      document.addEventListener('click', () => {
        options.classList.remove('show');
      });

      document.getElementById('commModal').addEventListener('show.bs.modal', () => {
        const btn = document.getElementById('btnClaimComm');
        loadCommissionData(btn);
      });

      document.getElementById('withdrawModal').addEventListener('show.bs.modal', async () => {
        const res = await axios.get('/me', {
          headers: {
            Authorization: `Bearer ${token}`,
            'Accept-Language': localStorage.getItem('lang') || 'en'
          }
        });

        const balance = parseFloat(res.data?.profile?.balance ?? 0).toFixed(2);
        document.getElementById('withdrawableAmount').textContent = `$${balance}`;
      });
    });

    document.getElementById('copyInviteBtn').addEventListener('click', function() {
      navigator.clipboard.writeText(
        document.getElementById('inviteCode').textContent
      );

      // create a popover instance with a green+white template
      const pop = bootstrap.Popover.getOrCreateInstance(this, {
        template: `
          <div class="popover rounded-pill" role="tooltip">
            <div class="popover-arrow"></div>
            <div class="popover-body bg-success text-white rounded-pill"></div>
          </div>`
      });

      pop.show();
      setTimeout(() => pop.hide(), 1500);
    });

    document.querySelectorAll('#languageModal .list-group-item').forEach(item => {
      item.addEventListener('click', () => {
        const selected = item.textContent.trim();
        let lang = 'en';

        if (selected === '中文') lang = 'zh';
        else if (selected === 'English') lang = 'en';
        // add other languages later

        localStorage.setItem('lang', lang);
        loadLanguage(lang);

        // 隐藏 modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('languageModal'));
        modal.hide();
      });
    });

    async function claimCommission() {
      const res = await axios.post(`${window.location.origin}/claim-commission`, {}, {
          headers: {
            Authorization: `Bearer ${token}`,
            'Accept-Language': localStorage.getItem('lang') || 'en'
          }
        });

        if (!res.data?.status) throw new Error(res.data?.message || 'Failed to claim commission.');

        const modal = bootstrap.Modal.getInstance(document.getElementById('commModal'));
        modal.hide();

        switchSection('funds');
    }

    function refreshUserProfile() {
      const token = localStorage.getItem('token');
      if (!token) return;
      
      axios.get(`${window.location.origin}/me`, {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => {
        if (res.data.status) {
          populateProfile(res.data.profile);
        }
      })
      .catch(err => {
        console.error('/me error:', err);
      });
    }

  </script>
</body>
</html>
